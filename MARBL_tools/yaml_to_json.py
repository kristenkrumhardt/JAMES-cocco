#!/usr/bin/env python

"""
YAML support is not part of the Python standard library, so it is possible that
users may find themselves running MARBL scripts in an environment that does not
have PyYAML. To support those users, MARBL relies soly on JSON versions of
default_settings.yaml and default_diagnostics.yaml which should be generated by
this script if either YAML file is changed.

Developers MUST update the YAML and then regenerate the JSON file(s); commits that
change the JSON file(s) alone will not be accepted.

usage: yaml_to_json.py [-h] [-s SETTINGS_FILE] [-d DIAGS_FILE] [-o OUTPUT_DIR]

Convert MARBL's YAML files to JSON

optional arguments:
  -h, --help            show this help message and exit
  -s SETTINGS_FILE, --settings_file SETTINGS_FILE
                        Location of YAML-formatted MARBL settings file to
                        convert to JSON (default:
                        $MARBLROOT/src/default_settings.yaml)
  -d DIAGS_FILE, --diags_file DIAGS_FILE
                        Location of YAML-formatted MARBL diagnostics file to
                        convert to JSON (default:
                        $MARBLROOT/src/default_diagnostics.yaml)
  -o OUTPUT_DIR, --output_dir OUTPUT_DIR
                        Directory where JSON file(s) will be created (default:
                        $MARBLROOT/autogenerated_src)


"""

#######################################

def _parse_args(marbl_root):
    """ Parse command line arguments
    """

    import argparse
    import os

    parser = argparse.ArgumentParser(description="Convert MARBL's YAML files to JSON",
                                     formatter_class=argparse.ArgumentDefaultsHelpFormatter)

    parser.add_argument('-s', '--settings_file', action='store', dest='settings_file',
                        default=os.path.join(marbl_root, 'src', 'default_settings.yaml'),
                        help='Location of YAML-formatted MARBL settings file to convert to JSON')

    parser.add_argument('-d', '--diags_file', action='store', dest='diags_file',
                        default=os.path.join(marbl_root, 'src', 'default_diagnostics.yaml'),
                        help='Location of YAML-formatted MARBL diagnostics file to convert to JSON')

    parser.add_argument('-o', '--output_dir', action='store', dest='output_dir',
                        default=os.path.join(marbl_root, 'autogenerated_src'),
                        help="Directory where JSON file(s) will be created")

    return parser.parse_args()

#######################################

import sys, os, json

# marbl_root is the top-level MARBL directory
marbl_root = os.path.abspath(os.path.join(os.path.dirname(sys.argv[0]), '..'))
sys.path.append(marbl_root)

# Parse command-line arguments (marbl_root is used to set default for YAML file location)
args = _parse_args(marbl_root)

# Set up logging
import logging
logging.basicConfig(format='%(levelname)s: %(message)s', level=logging.DEBUG)
logger = logging.getLogger("__name__")

# This tool requires PyYAML, error if it is not available
try:
    import yaml
except:
    logger.error("Can not find PyYAML library")
    sys.exit(1)

# Routines to verify that YAML files meet MARBL formatting requirements
from MARBL_tools import settings_dictionary_is_consistent, diagnostics_dictionary_is_consistent

# Read YAML files
for filename in [args.settings_file, args.diags_file]:
    if not os.path.isfile(filename):
        logger.error("File not found: "+filename)
        sys.exit(1)
    with open(filename) as file_in:
        yaml_in = yaml.safe_load(file_in)

    # YAML consistency checks (MARBL expects these files to be formatted
    # in a specific way)
    if filename == args.settings_file:
        if not settings_dictionary_is_consistent(yaml_in):
            logger.error("Formatting error in %s" % filename)
            sys.exit(1)
    if filename == args.diags_file:
        if not diagnostics_dictionary_is_consistent(yaml_in):
            logger.error("Formatting error in %s" % filename)
            sys.exit(1)

    # Write JSON file
    yaml_filename = filename.split(os.path.sep)[-1]
    if yaml_filename[-4:].lower() == "yaml":
        json_filename = yaml_filename[:-4] + "json"
    elif yaml_filename[-3:].lower() == "yml":
        json_filename = yaml_filename[:-3] + "json"
    else:
        json_filename = yaml_filename + ".json"
    with open(os.path.join(args.output_dir, json_filename), "w") as file_out:
        json.dump(yaml_in, file_out, separators=(',', ': '), sort_keys=True, indent=3)



